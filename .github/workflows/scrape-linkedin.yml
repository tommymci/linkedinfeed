name: Scrape LinkedIn Feeds

on:
  # Schedule: Run at 10 AM and 2 PM HKT (2 AM and 6 AM UTC)
  schedule:
    - cron: '0 2,6 * * *'  # 10 AM and 2 PM HKT

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      page:
        description: 'Page slug to scrape (e.g., master-concept) or "all" for all pages'
        required: false
        default: 'all'
        type: string

# Set permissions for GITHUB_TOKEN
permissions:
  contents: write  # Allow pushing to repository

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps

      - name: Restore encrypted session
        env:
          SESSION_KEY: ${{ secrets.SESSION_ENCRYPTION_KEY }}
        run: |
          mkdir -p browser_state
          if [ -f "browser_state/linkedin_state.json.enc" ]; then
            echo "üìÇ Decrypting session file..."
            openssl enc -aes-256-cbc -d -pbkdf2 \
              -in browser_state/linkedin_state.json.enc \
              -out browser_state/linkedin_state.json \
              -k "$SESSION_KEY"
            echo "‚úÖ Session restored"
          else
            echo "‚ö†Ô∏è  No encrypted session found - first run will require login"
          fi

      - name: Check Schedule Config
        if: github.event_name == 'schedule'
        id: check_schedule
        run: |
          ENABLED=$(jq -r '.schedule.enabled' pages_config.json)
          echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
          if [ "$ENABLED" != "true" ]; then
            echo "‚è∏Ô∏è  Scheduled scraping is disabled in config"
          fi

      - name: Scrape All Pages (Scheduled)
        if: github.event_name == 'schedule' && steps.check_schedule.outputs.enabled == 'true'
        env:
          HEADLESS: 'true'
        run: python scrape_all.py all

      - name: Scrape All Pages (Manual)
        if: github.event.inputs.page == 'all' && github.event_name == 'workflow_dispatch'
        env:
          HEADLESS: 'true'
        run: python scrape_all.py all

      - name: Scrape Specific Page
        if: github.event.inputs.page != 'all' && github.event.inputs.page != ''
        env:
          HEADLESS: 'true'
        run: python scrape_all.py ${{ github.event.inputs.page }}

      - name: Encrypt and save session
        if: always()
        env:
          SESSION_KEY: ${{ secrets.SESSION_ENCRYPTION_KEY }}
        run: |
          if [ -f "browser_state/linkedin_state.json" ]; then
            echo "üîí Encrypting session file..."
            openssl enc -aes-256-cbc -salt -pbkdf2 \
              -in browser_state/linkedin_state.json \
              -out browser_state/linkedin_state.json.enc \
              -k "$SESSION_KEY"
            echo "‚úÖ Session encrypted"
            rm browser_state/linkedin_state.json
          fi

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push changes
        run: |
          git add feed/*.xml feed/*.json feed/*.xsl browser_state/*.enc index.html

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "üìù No changes to commit"
          else
            TIMESTAMP=$(TZ='Asia/Hong_Kong' date '+%Y-%m-%d %I:%M %p HKT')
            git commit -m "Update feeds - ${TIMESTAMP}"
            git push
            echo "‚úÖ Changes pushed to main branch"
          fi
